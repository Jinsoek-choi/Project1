<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ëŒ€í™”í˜• ê´€ì‹¬ì‚¬ ë¶„ì„</title>
    <link rel="stylesheet" href="/css/chat.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="window">
    <!-- ìƒë‹¨ë°” -->
    <div class="header">
        <div class="diamond"></div>
        <div class="arrow"></div>
    </div>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <div class="chat-area" id="chatArea"></div>

    <!-- ì…ë ¥ì°½ -->
    <div class="input-area">
        <input id="userInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." />
        <button id="sendBtn">â–¶</button>
    </div>
</div>

<script>
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatArea = document.getElementById("chatArea");

    // ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸
    const botQuestions = [
      "ì§ˆë¬¸ 1: í˜¹ì‹œ ìµœê·¼ ì£¼ë§ì— ê°€ì¥ ì‹œê°„ ê°€ëŠ” ì¤„ ëª¨ë¥´ê³  ì§‘ì¤‘í–ˆë˜ ì¼ì´ë‚˜, ê°€ì¥ ì¦ê±°ì› ë˜ í™œë™ì´ ìˆìœ¼ì‹ ê°€ìš”?",
      "ì§ˆë¬¸ 2: ìš”ì¦˜ ë‰´ìŠ¤ë¥¼ ë³¼ ë•Œ ìì‹ ë„ ëª¨ë¥´ê²Œ ëˆˆê¸¸ì´ ê°€ê±°ë‚˜ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ë¶„ì•¼ì˜ ì†Œì‹ì´ ìˆìœ¼ì‹ ê°€ìš”?",
      "ì§ˆë¬¸ 3: ë§Œì•½ ê¸ˆì „ì ì¸ ì—¬ìœ ê°€ ìƒê¸´ë‹¤ë©´, ê°€ì¥ ë¨¼ì € íˆ¬ìí•˜ê±°ë‚˜ ë„ì „í•´ ë³´ê³  ì‹¶ì€ ë¶„ì•¼ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
      "ì§ˆë¬¸ 4: ì¼ìƒì—ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ìŒ“ì´ê±°ë‚˜ í”¼ë¡œí•  ë•Œ, ê°€ì¥ ì¦ê²¨ ì°¾ê±°ë‚˜ ëª°ì…í•˜ëŠ” 'ë‚˜ë§Œì˜ í•´ì†Œë²•'ì´ ìˆìœ¼ì‹ ê°€ìš”?",
      "ì§ˆë¬¸ 5: í˜¹ì‹œ ìµœê·¼ì— ìƒˆë¡­ê²Œ ë°°ìš°ê¸° ì‹œì‘í–ˆê±°ë‚˜, ì§€ì‹ì„ ìŒ“ê³  ìˆëŠ” ë¶„ì•¼ê°€ ìˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?"
    ];

    let qIndex = 0;
    let allowPlanQuestions = false;   // âœ… ì£¼ì œ ê´€ë ¨ ì§ˆë¬¸ ê°€ëŠ¥ ì—¬ë¶€
    let currentPlan = "";             // âœ… ìµœì‹  ì¼ì£¼ì¼ ê³„íš ì €ì¥
    let currentTopic = "";            // âœ… í˜„ì¬ ì£¼ì œ ì €ì¥

    // ğŸ§® ì´í•© ì ìˆ˜ ëˆ„ì ìš© ê°ì²´
    let totalScores = {
      "ì˜í™”/ë¯¸ë””ì–´": 0,
      "ìŠ¤í¬ì¸ ": 0,
      "ê²½ì œ/ì¬í…Œí¬": 0,
      "ê¸°ìˆ /IT": 0,
      "ì¼ìƒ/ì—¬í–‰": 0
    };

    // ğŸ’¬ ë§í’ì„  ì¶”ê°€ í•¨ìˆ˜
    function addMessage(text, sender = "user") {
      const div = document.createElement("div");
      div.className = sender === "user" ? "user-bubble" : "bot-bubble";
      div.innerHTML = text;
      chatArea.appendChild(div);
      scrollToBottom(50);
      return div;
    }

    // ğŸ¤– ì§ˆë¬¸ ì¶œë ¥ í•¨ìˆ˜
    function botAsk() {
      if (qIndex < botQuestions.length) {
        setTimeout(() => addMessage(botQuestions[qIndex++], "bot"), 300);
      } else {
        showFinalSummary(); // âœ… ë§ˆì§€ë§‰ ì§ˆë¬¸ ëë‚˜ë©´ ì´í•© ê³„ì‚° í˜¸ì¶œ
      }
    }

    // ğŸ“Š ì§ˆë¬¸ë³„ ê²°ê³¼ í‘œì‹œ
    function showResult(resultData) {
  addMessage("ë‹¹ì‹ ì˜ ë‹µë³€ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ê´€ì‹¬ì‚¬ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.", "bot");

  for (let key in resultData) totalScores[key] += resultData[key];

  const chartBubble = addMessage("", "bot");
  chartBubble.innerHTML = `
    <div class="result-box" style="
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 40px;
      flex-wrap: nowrap;
      background-color: #dcccff;
      border-radius: 20px;
      padding: 20px;
    ">
      <canvas id="resultChart${qIndex}" width="180" height="180"></canvas>

      <div class="custom-legend" style="
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        font-size: 15px;
        color: #3E3659;
        line-height: 1.4;
      "></div>
    </div>

    <ul class="rank-list" style="margin-top: 10px;">
      ${Object.entries(resultData)
        .sort((a, b) => b[1] - a[1])
        .map(([k, v], i) => `<li>${i + 1}. ${k} â€” ${v.toFixed(1)}%</li>`)
        .join("")}
    </ul>
  `;

  const ctx = chartBubble.querySelector(`#resultChart${qIndex}`);
  const legendDiv = chartBubble.querySelector(".custom-legend");
  legendDiv.style.display = "flex";
  legendDiv.style.flexDirection = "column"; // âœ… ìˆ˜ì§ ì •ë ¬ ìœ ì§€
  legendDiv.style.alignItems = "flex-start";
  legendDiv.style.gap = "10px"; // ê° ë²”ë¡€ ê°„ ê°„ê²©
  legendDiv.style.fontSize = "9px";
  legendDiv.style.lineHeight = "1.3";
  legendDiv.style.whiteSpace = "nowrap"; // âœ… ì¤„ë°”ê¿ˆ ê¸ˆì§€!
  legendDiv.style.width = "120px"; // âœ… ì¶©ë¶„í•œ í­ í™•ë³´
  legendDiv.style.marginLeft = "-10px";  // ìŒìˆ˜ê°’ìœ¼ë¡œ ì™¼ìª½ìœ¼ë¡œ ì´ë™
  const labels = Object.keys(resultData);
  const values = Object.values(resultData);
  const colors = ["#A391E3", "#C7B9FF", "#7A6EE0", "#BBAAF5", "#E5DFFF"];
  const zeroData = values.map(() => 0);

  const chart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: zeroData,
        backgroundColor: colors,
        borderWidth: 2,
        borderColor: "#3E3659"
      }]
    },
    options: {
      responsive: false,
      plugins: { legend: { display: false } },
      animation: {
        duration: 2200,
        easing: "easeOutQuart",
        animateRotate: true,
        animateScale: true
      }
    }
  });

  // ğŸ¨ ë²”ë¡€ë¥¼ HTMLë¡œ ìˆ˜ë™ ìƒì„±
  labels.forEach((label, i) => {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "8px";
    item.innerHTML = `
      <span style="display:inline-block;width:18px;height:12px;background:${colors[i]};border:1px solid #3E3659;border-radius:2px;"></span>
      ${label}
    `;
    legendDiv.appendChild(item);
  });

  // ğŸï¸ ì´¤ë¼ë½ ì• ë‹ˆë©”ì´ì…˜
  setTimeout(() => {
    chart.data.datasets[0].data = values;
    chart.update();
  }, 200);

  setTimeout(() => botAsk(), 1300);
}



    // ğŸ§  ìµœì¢… ê²°ê³¼ (5ë¬¸í•­ ëë‚˜ë©´ í˜¸ì¶œ)
    function showFinalSummary() {
      const sorted = Object.entries(totalScores).sort((a, b) => b[1] - a[1]);
      const top1 = sorted[0][0];
      const top2 = sorted[1][0];

      const summaryHTML = `
        <b>ìµœì¢… ê´€ì‹¬ì‚¬ ìˆœìœ„</b><br>
        1. ${sorted[0][0]}<br>
        2. ${sorted[1][0]}<br>
        3. ${sorted[2][0]}<br>
        4. ${sorted[3][0]}<br>
        5. ${sorted[4][0]}<br><br>
        ì´ì œ <b>${top1}</b>ì™€ <b>${top2}</b> ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.<br><br>
        <div class="choice-box">
          <button class="choice-btn" onclick="selectTopic('${top1}', this)">${top1}</button>
          <button class="choice-btn" onclick="selectTopic('${top2}', this)">${top2}</button>
        </div>
      `;
      addMessage(summaryHTML, "bot");
      chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: "smooth" });
    }

    // ğŸ”— ì£¼ì œ ì„ íƒ í›„ Spring ì„œë²„ë¡œ ìš”ì²­
    function selectTopic(topic, btn) {
      const box = btn.closest(".choice-box");
      box.style.transition = "opacity 0.6s ease";
      box.style.opacity = "0";

      setTimeout(() => {
        box.remove();
        currentTopic = topic; // âœ… ì£¼ì œ ì €ì¥
        addMessage(`${topic} ì£¼ì œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`, "user");

        const userAnswers = Array.from(
          document.querySelectorAll(".user-bubble")
        ).map(b => b.innerText);

        fetch("/api/plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, answers: userAnswers })
        })
          .then(res => res.json())
          .then(data => {
            currentPlan = data.plan;
            allowPlanQuestions = true;
            addMessage(`<b>${topic}</b>ì— ëŒ€í•œ ì¼ì£¼ì¼ ê³„íšì…ë‹ˆë‹¤:<br>${data.plan}`, "bot");
            addMessage("ì¶”ê°€ì ì¸ ê³„íš ë³€ê²½ì´ í•„ìš”í•˜ë©´ ë§í•´ì£¼ì„¸ìš” (ì˜ˆ: ì¼ìš”ì¼ ê³„íš ì•¼ì™¸ í™œë™ì„ í•  ìˆ˜ ìˆê²Œ ë°”ê¿”ì¤˜)", "bot");
          })
          .catch(err => {
            console.error("API ì—°ê²° ì‹¤íŒ¨:", err);
            addMessage(`âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜ (ì„ì‹œ ê³„íš í‘œì‹œ)<br>ì›”~ì¼ ${topic} ê´€ë ¨ í™œë™`, "bot");
          });
      }, 600);
    }

    // ğŸ§  ì‚¬ìš©ìê°€ ë‹µë³€ ì…ë ¥ ì‹œ
    function handleUserInput() {
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";

      if (allowPlanQuestions) {
        // âœ… ì£¼ì œ ê´€ë ¨ì„± íŒë‹¨
        const topicKeywords = [currentTopic, "ì¼ì •", "ìš”ì¼", "ê³„íš", "ì¶”ì²œ", "í™œë™"];
        const isTopicRelated = topicKeywords.some(k => text.includes(k));

        if (!isTopicRelated) {
          addMessage("ì£¼ì œ ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.", "bot");
          return;
        }

        // âœ… refine APIë¡œ ìˆ˜ì • ìš”ì²­
        fetch("/api/plan/refine", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ plan: currentPlan, request: text })
        })
          .then(res => res.json())
          .then(data => {
            currentPlan = data.plan;
            addMessage(`ìˆ˜ì •ëœ ì¼ì£¼ì¼ ê³„íšì…ë‹ˆë‹¤:<br>${data.plan}`, "bot");
          })
          .catch(() => addMessage("ê³„íš ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bot"));
      } else {
        // âš™ï¸ Flask ì—°ë™ (ì´ˆê¸° ì§ˆë¬¸ ë¶„ì„)
        fetch("/api/get-topic", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sentence: text })
        })
          .then(res => res.json())
          .then(data => {
            if (data.scores) showResult(data.scores);
            else addMessage("ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "bot");
          })
          .catch(() => addMessage("âš  Flask ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "bot"));
      }
    }

    function scrollToBottom(delay = 100) {
      setTimeout(() => chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: "instant" }), delay);
    }

    sendBtn.addEventListener("click", handleUserInput);
    input.addEventListener("keypress", e => e.key === "Enter" && handleUserInput());

    document.addEventListener("DOMContentLoaded", () => {
      qIndex = 0;
      botAsk();
    });
</script>

</script>
</body>
</html>
